<style>
  #zip-announcement {
    background: #fff;
    padding: 12px 16px;
    text-align: center;
    font-size: 14px;
    font-weight: 500;
    color: #425466;
    border-bottom: 1px solid #E5E7EB;
    position: sticky;
    top: 0;
    z-index: 9999;
  }
  #zip-announcement a {
    color: #635BFF;
    text-decoration: none;
    font-weight: 600;
    margin-left: 8px;
  }
  #zip-announcement a:hover {
    text-decoration: underline;
  }
  .zip-popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 24px;
    border-radius: 8px;
    box-shadow: 0px 8px 20px rgba(0, 0, 0, 0.15);
    text-align: center;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    z-index: 1000;
  }
  .zip-popup input {
    width: 80%;
    padding: 10px;
    margin: 10px 0;
    border: 1px solid #D1D5DB;
    border-radius: 6px;
    font-size: 16px;
  }
  .zip-popup button {
    background: #635BFF;
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 6px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
  }
  .zip-popup button:hover {
    background: #5145CD;
  }

  [id$="__header_local"],
  [id$="__header_zone4"],
  [id$="__header_zones2_3"],
  [id$="__header_zones5_8"] {
    visibility: hidden;
  }
</style>

      <div id="zip-announcement"></div>
<div id="zip-popup" class="zip-popup" style="display: none;">
  <p>Share your zip code to see what’s available near you.</p>
  <input type="text" id="zip-input" placeholder="Enter zip code">
  <br>
  <button id="zip-submit">Submit</button>
</div>

  <script src="{{ 'geo-local.js' | asset_url }}"></script>
  <script src="{{ 'geo-zones-2-3.js' | asset_url }}"></script>
  <script src="{{ 'geo-zone-4.js' | asset_url }}"></script>
  <script src="{{ 'geo-zones-5-8.js' | asset_url }}"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
      var allowedZips = {
        "geo-local": window.geoLocalZips || [],
        "geo-zones-2-3": window.geoZones2_3Zips || [],
        "geo-zone-4": window.geoZone4Zips || [],
        "geo-zones-5-8": window.geoZones5_8Zips || []
      };

  var multiColumnSections = {
    "geo-local": "shopify-section-template--24466623889686__multi_column_main_local",
    "geo-zones-2-3": "shopify-section-template--24466623889686__multi_column_main_zone_2_3",
    "geo-zone-4": "shopify-section-template--24466623889686__multi_column_main_zone_4",
    "geo-zones-5-8": "shopify-section-template--24466623889686__multi_column_main-zones_5_8"
  };

  var zipCode = localStorage.getItem("user_zipcode");
  var zipPopup = document.getElementById("zip-popup");
  var zipInput = document.getElementById("zip-input");
  var zipSubmit = document.getElementById("zip-submit");
  var zipAnnouncement = document.getElementById("zip-announcement");

  function setZipCode(zip) {
    localStorage.setItem("user_zipcode", zip);
    updateAnnouncementBar(zip);
    filterNavigationByZip(zip);
    filterProductsByZip(zip);
    showMultiColumnByZip(zip);
    redirectBasedOnZip(zip);
  }

  function updateAnnouncementBar(zip) {
    zipAnnouncement.innerHTML = zip + ' <a href="#" id="change-zip">Change Zipcode</a>';
  }

  function askForZipCode(prefillZip = "") {
    if (prefillZip) {
      zipInput.value = prefillZip;
    }
    zipPopup.style.display = "block";
  }

  function tryGeolocationPrefill(callback) {
    fetch("https://ipapi.co/json/")
      .then(response => response.json())
      .then(data => {
        if (data && data.postal) {
          const zip = data.postal.trim();
          callback(zip);
        } else {
          callback("");
        }
      })
      .catch(() => {
        callback("");
      });
  }

  if (!zipCode) {
    tryGeolocationPrefill(function (geoZip) {
      if (geoZip) {
        setZipCode(geoZip); 
        askForZipCode(geoZip);
      } else {
        askForZipCode();
      }
    });
  } else {
    updateAnnouncementBar(zipCode);
    filterNavigationByZip(zipCode);
    filterProductsByZip(zipCode);
    showMultiColumnByZip(zipCode);
    redirectBasedOnZip(zipCode);
  }

  zipSubmit.addEventListener("click", function () {
    var userZip = zipInput.value.trim();
    if (userZip) {
      zipPopup.style.display = "none";
      setZipCode(userZip);
    }
  });

  document.addEventListener("click", function (e) {
    if (e.target && e.target.id === "change-zip") {
      askForZipCode(localStorage.getItem("user_zipcode") || "");
    }
  });

  function filterProductsByZip(userZip) {
    var productLinks = document.querySelectorAll("a[href*='/collections/']");
    productLinks.forEach(function(link) {
      var href = link.getAttribute("href");
      var regex = /\/collections\/([^\/]+)\/products\//;
      var match = href.match(regex);
      if (match) {
        var collection = match[1];
        if (allowedZips[collection]) {
          if (allowedZips[collection].indexOf(userZip) === -1) {
            var productItem = link.closest(".product-item") || link.closest(".grid__item");
            if (productItem) {
              productItem.style.display = "none";
            } else {
              link.style.display = "none";
            }
          }
        }
      }
    });
  }

  function filterNavigationByZip(userZip) {
    var navMapping = {
      "header_local": "geo-local",
      "header_zone4": "geo-zone-4",
      "header_zones2_3": "geo-zones-2-3",
      "header_zones5_8": "geo-zones-5-8"
    };

    Object.keys(navMapping).forEach(function(navKey) {
      var zoneKey = navMapping[navKey];
      var navElements = document.querySelectorAll('[id$="__' + navKey + '"]');
      navElements.forEach(function(el) {
        if (allowedZips[zoneKey] && allowedZips[zoneKey].indexOf(userZip) === -1) {
          el.style.display = "none";
        } else {
          el.style.display = "block";
        }
        el.style.visibility = "visible";
      });
    });
  }

  function showMultiColumnByZip(userZip) {
    Object.keys(multiColumnSections).forEach(function(zoneKey) {
      var sectionId = multiColumnSections[zoneKey];
      var section = document.getElementById(sectionId);
      if (section) {
        if (allowedZips[zoneKey] && allowedZips[zoneKey].indexOf(userZip) === -1) {
          section.style.display = "none";
        } else {
          section.style.display = "block";
        }
      }
    });
  }

  function redirectBasedOnZip(userZip) {
    // Remove any trailing slash from the path
    var currentPath = window.location.pathname.replace(/\/$/, '');
    if (currentPath === '/pages/cleanse-programs') {
      if (allowedZips["geo-local"].indexOf(userZip) !== -1) {
        // User is in geo-local—stay on this page.
        return;
      } else if (allowedZips["geo-zone-4"].indexOf(userZip) !== -1) {
        window.location.href = "https://hi-vibe.com/pages/cleanse-programs-4";
      } else if (allowedZips["geo-zones-2-3"].indexOf(userZip) !== -1) {
        window.location.href = "https://hi-vibe.com/pages/cleanse-programs-2-3";
      } else if (allowedZips["geo-zones-5-8"].indexOf(userZip) !== -1) {
        window.location.href = "https://hi-vibe.com/pages/cleanse-programs-5-8";
      }
    }
  }
});
</script>

<!--
Page mapping:
Local: https://hi-vibe.com/pages/cleanse-programs
Zones 4: https://hi-vibe.com/pages/cleanse-programs-4
Zones 2-3: https://hi-vibe.com/pages/cleanse-programs-2-3
Zones 5-8: https://hi-vibe.com/pages/cleanse-programs-5-8
-->
